version: 2
jobs:
  build:
    docker:
      - image: node:10
    steps:
      - checkout
      - run: npm i
      - run: npm run build
      - add_ssh_keys:
            fingerprints:
              - "23:5c:b7:18:6e:ae:32:d9:dc:41:0b:d7:59:5e:50:40"
      - run: tar -cf build.tar build public
      - run: ssh-keyscan -H $SSH_HOST -p $SSH_PORT >> ~/.ssh/known_hosts
      - run: scp -P $SSH_PORT build.tar $SSH_USER@$SSH_HOST:~/knowledge.uz/knowledge_frontend/
      - run: ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "cd knowledge.uz/knowledge_frontend && tar -xf build.tar && git pull --rebase origin master && sleep 2; echo $ROOT_PASS | sudo -sS docker-compose restart"

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
